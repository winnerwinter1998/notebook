<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.1.2, mkdocs-material-5.1.7"><title>Remote Procedure Call - Notes</title><link rel=stylesheet href=../../assets/stylesheets/main.4c7052ca.min.css><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style></head> <body dir=ltr> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#remote-procedure-call class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid" aria-label=Header> <a href=../.. title=Notes class="md-header-nav__button md-logo" aria-label=Notes> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg> </a> <label class="md-header-nav__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header-nav__title data-md-component=header-title> <div class=md-header-nav__ellipsis> <span class="md-header-nav__topic md-ellipsis"> Notes </span> <span class="md-header-nav__topic md-ellipsis"> Remote Procedure Call </span> </div> </div> <label class="md-header-nav__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear data-md-component=search-reset tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class="md-tabs__link md-tabs__link--active"> Home </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title=Notes class="md-nav__button md-logo" aria-label=Notes> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg> </a> Notes </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. title=Home class=md-nav__link> Home </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </span> Table of contents </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#rpc-hello-world class=md-nav__link> RPCç‰ˆ Hello World </a> </li> <li class=md-nav__item> <a href=#hello-world class=md-nav__link> é‡æ„ Hello World </a> </li> <li class=md-nav__item> <a href=#_1 class=md-nav__link> è¯­è¨€æ— å…³ </a> </li> <li class=md-nav__item> <a href=#httprpc class=md-nav__link> Httpä¸Šçš„RPC </a> </li> <li class=md-nav__item> <a href=#rpc class=md-nav__link> æ›´å¤š RPC ç¤ºä¾‹ </a> <nav class=md-nav aria-label="æ›´å¤š RPC ç¤ºä¾‹"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#http-rpc class=md-nav__link> HTTP RPC </a> </li> <li class=md-nav__item> <a href=#tcp-rpc class=md-nav__link> TCP RPC </a> </li> <li class=md-nav__item> <a href=#json-rpc class=md-nav__link> JSON RPC </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <h1 id=remote-procedure-call>Remote Procedure Call<a class=headerlink href=#remote-procedure-call title="Permanent link">&para;</a></h1> <p>Goè¯­è¨€çš„RPCåŒ…çš„è·¯å¾„ä¸ºnet/rpcï¼Œä¹Ÿå°±æ˜¯æ”¾åœ¨äº†netåŒ…ç›®å½•ä¸‹é¢ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥çŒœæµ‹è¯¥RPCåŒ…æ˜¯å»ºç«‹åœ¨netåŒ…åŸºç¡€ä¹‹ä¸Šçš„ã€‚</p> <p>Goæ ‡å‡†åŒ…ä¸­å·²ç»æä¾›äº†å¯¹RPCçš„æ”¯æŒï¼Œè€Œä¸”æ”¯æŒä¸‰ä¸ªçº§åˆ«çš„RPCï¼šTCPã€HTTPã€JSONRPCã€‚ä½†Goçš„RPCåŒ…æ˜¯ç‹¬ä¸€æ— äºŒçš„RPCï¼Œå®ƒå’Œä¼ ç»Ÿçš„RPCç³»ç»Ÿä¸åŒï¼Œå®ƒåªæ”¯æŒGoå¼€å‘çš„æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ä¹‹é—´çš„äº¤äº’ï¼Œå› ä¸ºåœ¨å†…éƒ¨ï¼Œå®ƒä»¬é‡‡ç”¨äº†Gobæ¥ç¼–ç ã€‚</p> <p>Go RPCçš„å‡½æ•°åªæœ‰ç¬¦åˆä¸‹é¢çš„æ¡ä»¶æ‰èƒ½è¢«è¿œç¨‹è®¿é—®ï¼Œä¸ç„¶ä¼šè¢«å¿½ç•¥ï¼Œè¯¦ç»†çš„è¦æ±‚å¦‚ä¸‹ï¼š</p> <ul> <li>å‡½æ•°å¿…é¡»æ˜¯å¯¼å‡ºçš„(é¦–å­—æ¯å¤§å†™)</li> <li>å¿…é¡»æœ‰ä¸¤ä¸ªå¯¼å‡ºç±»å‹çš„å‚æ•°ï¼Œ</li> <li>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ¥æ”¶çš„å‚æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¿”å›ç»™å®¢æˆ·ç«¯çš„å‚æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°å¿…é¡»æ˜¯æŒ‡é’ˆç±»å‹çš„</li> <li>å‡½æ•°è¿˜è¦æœ‰ä¸€ä¸ªè¿”å›å€¼error</li> </ul> <p>ä¸¾ä¸ªğŸŒ°ï¼Œä»¥ä¸‹çš„RPCå‡½æ•°æ ¼å¼æ­£ç¡®ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>func</span> <span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>T</span><span class=p>)</span> <span class=nx>MethodName</span><span class=p>(</span><span class=nx>argType</span> <span class=nx>T1</span><span class=p>,</span> <span class=nx>replyType</span> <span class=o>*</span><span class=nx>T2</span><span class=p>)</span> <span class=kt>error</span>
</code></pre></div> <p>Tã€T1å’ŒT2ç±»å‹å¿…é¡»èƒ½è¢«<code>encoding/gob</code>åŒ…ç¼–è§£ç ã€‚</p> <p>ä»»ä½•çš„RPCéƒ½éœ€è¦é€šè¿‡ç½‘ç»œæ¥ä¼ é€’æ•°æ®ï¼ŒGo RPCå¯ä»¥åˆ©ç”¨HTTPå’ŒTCPæ¥ä¼ é€’æ•°æ®ï¼Œåˆ©ç”¨HTTPçš„å¥½å¤„æ˜¯å¯ä»¥ç›´æ¥å¤ç”¨<code>net/http</code>é‡Œé¢çš„ä¸€äº›å‡½æ•°ã€‚</p> <h2 id=rpc-hello-world>RPCç‰ˆ Hello World<a class=headerlink href=#rpc-hello-world title="Permanent link">&para;</a></h2> <p>æˆ‘ä»¬å…ˆæ„é€ ä¸€ä¸ªHelloServiceç±»å‹ï¼Œå…¶ä¸­çš„Helloæ–¹æ³•ç”¨äºå®ç°æ‰“å°åŠŸèƒ½ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>type</span> <span class=nx>HelloService</span> <span class=kd>struct</span> <span class=p>{}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>HelloService</span><span class=p>)</span> <span class=nx>Hello</span><span class=p>(</span><span class=nx>request</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>reply</span> <span class=o>*</span><span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=o>*</span><span class=nx>reply</span> <span class=p>=</span> <span class=s>&quot;hello:&quot;</span> <span class=o>+</span> <span class=nx>request</span>
    <span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>
</code></pre></div> <p>å…¶ä¸­Helloæ–¹æ³•å¿…é¡»æ»¡è¶³Goè¯­è¨€çš„RPCè§„åˆ™ï¼šæ–¹æ³•åªèƒ½æœ‰ä¸¤ä¸ªå¯åºåˆ—åŒ–çš„å‚æ•°ï¼Œå…¶ä¸­ç¬¬äºŒä¸ªå‚æ•°æ˜¯æŒ‡é’ˆç±»å‹ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªerrorç±»å‹ï¼ŒåŒæ—¶å¿…é¡»æ˜¯å…¬å¼€çš„æ–¹æ³•ã€‚</p> <p>ç„¶åå°±å¯ä»¥å°†HelloServiceç±»å‹çš„å¯¹è±¡æ³¨å†Œä¸ºä¸€ä¸ªRPCæœåŠ¡ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>func</span> <span class=nx>main</span><span class=p>()</span> <span class=p>{</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nx>RegisterName</span><span class=p>(</span><span class=s>&quot;HelloService&quot;</span><span class=p>,</span> <span class=nb>new</span><span class=p>(</span><span class=nx>HelloService</span><span class=p>))</span>

    <span class=nx>listener</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nx>Listen</span><span class=p>(</span><span class=s>&quot;tcp&quot;</span><span class=p>,</span> <span class=s>&quot;:1234&quot;</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>log</span><span class=p>.</span><span class=nx>Fatal</span><span class=p>(</span><span class=s>&quot;ListenTCP error:&quot;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>listener</span><span class=p>.</span><span class=nx>Accept</span><span class=p>()</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>log</span><span class=p>.</span><span class=nx>Fatal</span><span class=p>(</span><span class=s>&quot;Accept error:&quot;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=nx>rpc</span><span class=p>.</span><span class=nx>ServeConn</span><span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div> <p>å…¶ä¸­rpc.Registerå‡½æ•°è°ƒç”¨ä¼šå°†å¯¹è±¡ç±»å‹ä¸­æ‰€æœ‰æ»¡è¶³RPCè§„åˆ™çš„å¯¹è±¡æ–¹æ³•æ³¨å†Œä¸ºRPCå‡½æ•°ï¼Œæ‰€æœ‰æ³¨å†Œçš„æ–¹æ³•ä¼šæ”¾åœ¨â€œHelloServiceâ€æœåŠ¡ç©ºé—´ä¹‹ä¸‹ã€‚ç„¶åæˆ‘ä»¬å»ºç«‹ä¸€ä¸ªå”¯ä¸€çš„TCPé“¾æ¥ï¼Œå¹¶ä¸”é€šè¿‡rpc.ServeConnå‡½æ•°åœ¨è¯¥TCPé“¾æ¥ä¸Šä¸ºå¯¹æ–¹æä¾›RPCæœåŠ¡ã€‚</p> <p>ä¸‹é¢æ˜¯å®¢æˆ·ç«¯è¯·æ±‚HelloServiceæœåŠ¡çš„ä»£ç ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>func</span> <span class=nx>main</span><span class=p>()</span> <span class=p>{</span>
    <span class=nx>client</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rpc</span><span class=p>.</span><span class=nx>Dial</span><span class=p>(</span><span class=s>&quot;tcp&quot;</span><span class=p>,</span> <span class=s>&quot;localhost:1234&quot;</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>log</span><span class=p>.</span><span class=nx>Fatal</span><span class=p>(</span><span class=s>&quot;dialing:&quot;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=kd>var</span> <span class=nx>reply</span> <span class=kt>string</span>
    <span class=nx>err</span> <span class=p>=</span> <span class=nx>client</span><span class=p>.</span><span class=nx>Call</span><span class=p>(</span><span class=s>&quot;HelloService.Hello&quot;</span><span class=p>,</span> <span class=s>&quot;hello&quot;</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>reply</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>log</span><span class=p>.</span><span class=nx>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=nx>fmt</span><span class=p>.</span><span class=nx>Println</span><span class=p>(</span><span class=nx>reply</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div> <p>é¦–å…ˆæ˜¯é€šè¿‡rpc.Dialæ‹¨å·RPCæœåŠ¡ï¼Œç„¶åé€šè¿‡client.Callè°ƒç”¨å…·ä½“çš„RPCæ–¹æ³•ã€‚åœ¨è°ƒç”¨client.Callæ—¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç”¨ç‚¹å·é“¾æ¥çš„RPCæœåŠ¡åå­—å’Œæ–¹æ³•åå­—ï¼Œç¬¬äºŒå’Œç¬¬ä¸‰ä¸ªå‚æ•°åˆ†åˆ«æˆ‘ä»¬å®šä¹‰RPCæ–¹æ³•çš„ä¸¤ä¸ªå‚æ•°ã€‚</p> <h2 id=hello-world>é‡æ„ Hello World<a class=headerlink href=#hello-world title="Permanent link">&para;</a></h2> <p>ä¸€èˆ¬RPCå¼€å‘ä¼šå…ˆå®šä¹‰æ¥å£è§„èŒƒï¼Œå†å®šä¹‰ä¸¤ç«¯çš„å…·ä½“æ“ä½œã€‚</p> <p>RPCæœåŠ¡çš„æ¥å£è§„èŒƒåˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼šé¦–å…ˆæ˜¯æœåŠ¡çš„åå­—ï¼Œç„¶åæ˜¯æœåŠ¡è¦å®ç°çš„è¯¦ç»†æ–¹æ³•åˆ—è¡¨ï¼Œæœ€åæ˜¯æ³¨å†Œè¯¥ç±»å‹æœåŠ¡çš„å‡½æ•°ã€‚ä¸ºäº†é¿å…åå­—å†²çªï¼Œæˆ‘ä»¬åœ¨RPCæœåŠ¡çš„åå­—ä¸­å¢åŠ äº†åŒ…è·¯å¾„å‰ç¼€ï¼ˆè¿™ä¸ªæ˜¯RPCæœåŠ¡æŠ½è±¡çš„åŒ…è·¯å¾„ï¼Œå¹¶éå®Œå…¨ç­‰ä»·Goè¯­è¨€çš„åŒ…è·¯å¾„ï¼‰ã€‚RegisterHelloServiceæ³¨å†ŒæœåŠ¡æ—¶ï¼Œç¼–è¯‘å™¨ä¼šè¦æ±‚ä¼ å…¥çš„å¯¹è±¡æ»¡è¶³HelloServiceInterfaceæ¥å£ã€‚</p> <p>æœåŠ¡çš„åå­—å’Œæ¥å£ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>type</span> <span class=nx>HelloServiceClient</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=o>*</span><span class=nx>rpc</span><span class=p>.</span><span class=nx>Client</span>
<span class=p>}</span>

<span class=kd>var</span> <span class=nx>_</span> <span class=nx>HelloServiceInterface</span> <span class=p>=</span> <span class=p>(</span><span class=o>*</span><span class=nx>HelloServiceClient</span><span class=p>)(</span><span class=kc>nil</span><span class=p>)</span>

<span class=kd>func</span> <span class=nx>DialHelloService</span><span class=p>(</span><span class=nx>network</span><span class=p>,</span> <span class=nx>address</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>HelloServiceClient</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
    <span class=nx>c</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rpc</span><span class=p>.</span><span class=nx>Dial</span><span class=p>(</span><span class=nx>network</span><span class=p>,</span> <span class=nx>address</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
    <span class=p>}</span>
    <span class=k>return</span> <span class=o>&amp;</span><span class=nx>HelloServiceClient</span><span class=p>{</span><span class=nx>Client</span><span class=p>:</span> <span class=nx>c</span><span class=p>},</span> <span class=kc>nil</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>HelloServiceClient</span><span class=p>)</span> <span class=nx>Hello</span><span class=p>(</span><span class=nx>request</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>reply</span> <span class=o>*</span><span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=k>return</span> <span class=nx>p</span><span class=p>.</span><span class=nx>Client</span><span class=p>.</span><span class=nx>Call</span><span class=p>(</span><span class=nx>HelloServiceName</span><span class=o>+</span><span class=s>&quot;.Hello&quot;</span><span class=p>,</span> <span class=nx>request</span><span class=p>,</span> <span class=nx>reply</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div> <p>å®¢æˆ·ç«¯ä»£ç ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>func</span> <span class=nx>main</span><span class=p>()</span> <span class=p>{</span>
    <span class=nx>client</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>DialHelloService</span><span class=p>(</span><span class=s>&quot;tcp&quot;</span><span class=p>,</span> <span class=s>&quot;localhost:1234&quot;</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>log</span><span class=p>.</span><span class=nx>Fatal</span><span class=p>(</span><span class=s>&quot;dialing:&quot;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=kd>var</span> <span class=nx>reply</span> <span class=kt>string</span>
    <span class=nx>err</span> <span class=p>=</span> <span class=nx>client</span><span class=p>.</span><span class=nx>Hello</span><span class=p>(</span><span class=s>&quot;hello&quot;</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>reply</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>log</span><span class=p>.</span><span class=nx>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>æœåŠ¡ç«¯ä»£ç ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>type</span> <span class=nx>HelloService</span> <span class=kd>struct</span> <span class=p>{}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>p</span> <span class=o>*</span><span class=nx>HelloService</span><span class=p>)</span> <span class=nx>Hello</span><span class=p>(</span><span class=nx>request</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>reply</span> <span class=o>*</span><span class=kt>string</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=o>*</span><span class=nx>reply</span> <span class=p>=</span> <span class=s>&quot;hello:&quot;</span> <span class=o>+</span> <span class=nx>request</span>
    <span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nx>main</span><span class=p>()</span> <span class=p>{</span>
    <span class=nx>RegisterHelloService</span><span class=p>(</span><span class=nb>new</span><span class=p>(</span><span class=nx>HelloService</span><span class=p>))</span>

    <span class=nx>listener</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nx>Listen</span><span class=p>(</span><span class=s>&quot;tcp&quot;</span><span class=p>,</span> <span class=s>&quot;:1234&quot;</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>log</span><span class=p>.</span><span class=nx>Fatal</span><span class=p>(</span><span class=s>&quot;ListenTCP error:&quot;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=k>for</span> <span class=p>{</span>
        <span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>listener</span><span class=p>.</span><span class=nx>Accept</span><span class=p>()</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=nx>log</span><span class=p>.</span><span class=nx>Fatal</span><span class=p>(</span><span class=s>&quot;Accept error:&quot;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
        <span class=p>}</span>

        <span class=k>go</span> <span class=nx>rpc</span><span class=p>.</span><span class=nx>ServeConn</span><span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>åœ¨æ–°çš„RPCæœåŠ¡ç«¯å®ç°ä¸­ï¼Œæˆ‘ä»¬ç”¨RegisterHelloServiceå‡½æ•°æ¥æ³¨å†Œå‡½æ•°ï¼Œè¿™æ ·ä¸ä»…å¯ä»¥é¿å…å‘½åæœåŠ¡åç§°çš„å·¥ä½œï¼ŒåŒæ—¶ä¹Ÿä¿è¯äº†ä¼ å…¥çš„æœåŠ¡å¯¹è±¡æ»¡è¶³äº†RPCæ¥å£çš„å®šä¹‰ã€‚æœ€åæˆ‘ä»¬æ–°çš„æœåŠ¡æ”¹ä¸ºæ”¯æŒå¤šä¸ªTCPé“¾æ¥ï¼Œç„¶åä¸ºæ¯ä¸ªTCPé“¾æ¥æä¾›RPCæœåŠ¡ã€‚</p> <h2 id=_1>è¯­è¨€æ— å…³<a class=headerlink href=#_1 title="Permanent link">&para;</a></h2> <p>è¯­è¨€æ— å…³æ˜¯æŒ‡ï¼šæ— è®ºé‡‡ç”¨ä½•ç§ç¼–ç¨‹è¯­è¨€ï¼Œåªè¦éµå¾ªåŒæ ·çš„jsonç»“æ„ï¼Œä»¥åŒæ ·çš„æµç¨‹å°±å¯ä»¥å’ŒGoè¯­è¨€ç¼–å†™çš„RPCæœåŠ¡è¿›è¡Œé€šä¿¡ã€‚è¿™æ ·æˆ‘ä»¬å°±å®ç°äº†è¯­è¨€æ— å…³çš„RPCã€‚</p> <p>æ ‡å‡†åº“çš„RPCé»˜è®¤é‡‡ç”¨Goè¯­è¨€ç‰¹æœ‰çš„gobç¼–ç ï¼Œå› æ­¤ä»å…¶å®ƒè¯­è¨€è°ƒç”¨Goè¯­è¨€å®ç°çš„RPCæœåŠ¡å°†æ¯”è¾ƒå›°éš¾ï¼Œè€Œæ¯ä¸ªRPCä»¥åŠæœåŠ¡çš„ä½¿ç”¨è€…éƒ½å¯èƒ½é‡‡ç”¨ä¸åŒçš„ç¼–ç¨‹è¯­è¨€ã€‚å¾—ç›ŠäºRPCçš„æ¡†æ¶è®¾è®¡ï¼ŒGoè¯­è¨€çš„RPCå…¶å®ä¹Ÿæ˜¯å¾ˆå®¹æ˜“å®ç°è·¨è¯­è¨€æ”¯æŒçš„ã€‚</p> <p>Goè¯­è¨€çš„RPCæ¡†æ¶æœ‰ä¸¤ä¸ªæ¯”è¾ƒæœ‰ç‰¹è‰²çš„è®¾è®¡ï¼š</p> <ol> <li>RPCæ•°æ®æ‰“åŒ…æ—¶å¯ä»¥é€šè¿‡æ’ä»¶å®ç°è‡ªå®šä¹‰çš„ç¼–ç å’Œè§£ç ã€‚</li> <li>RPCå»ºç«‹åœ¨æŠ½è±¡çš„io.ReadWriteCloseræ¥å£ä¹‹ä¸Šçš„ï¼Œæˆ‘ä»¬å¯ä»¥å°†RPCæ¶è®¾åœ¨ä¸åŒçš„é€šè®¯åè®®ä¹‹ä¸Šã€‚</li> </ol> <p>ä¸¾ä¸ªğŸŒ°ï¼Œè¿™é‡Œæˆ‘ä»¬å°†å°è¯•é€šè¿‡å®˜æ–¹è‡ªå¸¦çš„net/rpc/jsonrpcæ‰©å±•å®ç°ä¸€ä¸ªè·¨è¯­è¨€çš„RPCã€‚</p> <p>åŸºäºJSONç¼–ç é‡æ–°å®ç°RPCæœåŠ¡ç«¯ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>func</span> <span class=nx>main</span><span class=p>()</span> <span class=p>{</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nx>RegisterName</span><span class=p>(</span><span class=s>&quot;HelloService&quot;</span><span class=p>,</span> <span class=nb>new</span><span class=p>(</span><span class=nx>HelloService</span><span class=p>))</span>

    <span class=nx>listener</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nx>Listen</span><span class=p>(</span><span class=s>&quot;tcp&quot;</span><span class=p>,</span> <span class=s>&quot;:1234&quot;</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>log</span><span class=p>.</span><span class=nx>Fatal</span><span class=p>(</span><span class=s>&quot;ListenTCP error:&quot;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=k>for</span> <span class=p>{</span>
        <span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>listener</span><span class=p>.</span><span class=nx>Accept</span><span class=p>()</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=nx>log</span><span class=p>.</span><span class=nx>Fatal</span><span class=p>(</span><span class=s>&quot;Accept error:&quot;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
        <span class=p>}</span>

        <span class=k>go</span> <span class=nx>rpc</span><span class=p>.</span><span class=nx>ServeCodec</span><span class=p>(</span><span class=nx>jsonrpc</span><span class=p>.</span><span class=nx>NewServerCodec</span><span class=p>(</span><span class=nx>conn</span><span class=p>))</span>  <span class=c1>// å–ä»£äº†rpc.ServeConnå‡½æ•°</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>ä»£ç ä¸­æœ€å¤§çš„å˜åŒ–æ˜¯ç”¨rpc.ServeCodecå‡½æ•°æ›¿ä»£äº†rpc.ServeConnå‡½æ•°ï¼Œä¼ å…¥çš„å‚æ•°æ˜¯é’ˆå¯¹æœåŠ¡ç«¯çš„jsonç¼–è§£ç å™¨ã€‚</p> <p>JSONç‰ˆæœ¬çš„å®¢æˆ·ç«¯ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>func</span> <span class=nx>main</span><span class=p>()</span> <span class=p>{</span>
    <span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nx>Dial</span><span class=p>(</span><span class=s>&quot;tcp&quot;</span><span class=p>,</span> <span class=s>&quot;localhost:1234&quot;</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>log</span><span class=p>.</span><span class=nx>Fatal</span><span class=p>(</span><span class=s>&quot;net.Dial:&quot;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=nx>client</span> <span class=o>:=</span> <span class=nx>rpc</span><span class=p>.</span><span class=nx>NewClientWithCodec</span><span class=p>(</span><span class=nx>jsonrpc</span><span class=p>.</span><span class=nx>NewClientCodec</span><span class=p>(</span><span class=nx>conn</span><span class=p>))</span>

    <span class=kd>var</span> <span class=nx>reply</span> <span class=kt>string</span>
    <span class=nx>err</span> <span class=p>=</span> <span class=nx>client</span><span class=p>.</span><span class=nx>Call</span><span class=p>(</span><span class=s>&quot;HelloService.Hello&quot;</span><span class=p>,</span> <span class=s>&quot;hello&quot;</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>reply</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>log</span><span class=p>.</span><span class=nx>Fatal</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>

    <span class=nx>fmt</span><span class=p>.</span><span class=nx>Println</span><span class=p>(</span><span class=nx>reply</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div> <p>å…ˆæ‰‹å·¥è°ƒç”¨net.Dialå‡½æ•°å»ºç«‹TCPé“¾æ¥ï¼Œç„¶ååŸºäºè¯¥é“¾æ¥å»ºç«‹é’ˆå¯¹å®¢æˆ·ç«¯çš„jsonç¼–è§£ç å™¨ã€‚</p> <p>åœ¨ç¡®ä¿å®¢æˆ·ç«¯å¯ä»¥æ­£å¸¸è°ƒç”¨RPCæœåŠ¡çš„æ–¹æ³•ä¹‹åï¼Œæˆ‘ä»¬åœ¨å®¢æˆ·ç«¯ç”¨ä¸€ä¸ªæ™®é€šçš„TCPæœåŠ¡ä»£æ›¿Goè¯­è¨€ç‰ˆæœ¬çš„RPCæœåŠ¡ï¼Œè¿™æ ·å¯ä»¥æŸ¥çœ‹å®¢æˆ·ç«¯è°ƒç”¨æ—¶å‘é€çš„æ•°æ®æ ¼å¼ã€‚æ¯”å¦‚åœ¨å®¢æˆ·ç«¯é€šè¿‡ncå‘½ä»¤<code>nc -l 1234</code>åœ¨åŒæ ·çš„ç«¯å£å¯åŠ¨ä¸€ä¸ªTCPæœåŠ¡ã€‚ç„¶åå†æ¬¡æ‰§è¡Œä¸€æ¬¡RPCè°ƒç”¨å°†ä¼šå‘ç°ncè¾“å‡ºäº†ä»¥ä¸‹çš„ä¿¡æ¯ï¼š</p> <div class=highlight><pre><span></span><code><span class=p>{</span><span class=nt>&quot;method&quot;</span><span class=p>:</span><span class=s2>&quot;HelloService.Hello&quot;</span><span class=p>,</span><span class=nt>&quot;params&quot;</span><span class=p>:[</span><span class=s2>&quot;hello&quot;</span><span class=p>],</span><span class=nt>&quot;id&quot;</span><span class=p>:</span><span class=mi>0</span><span class=p>}</span>
</code></pre></div> <p>methodéƒ¨åˆ†å¯¹åº”è¦è°ƒç”¨çš„rpcæœåŠ¡å’Œæ–¹æ³•ç»„åˆæˆçš„åå­—ï¼Œparamséƒ¨åˆ†çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä¸ºå‚æ•°ï¼Œidæ˜¯ç”±è°ƒç”¨ç«¯ç»´æŠ¤çš„ä¸€ä¸ªå”¯ä¸€çš„è°ƒç”¨ç¼–å·ã€‚</p> <p>è¯·æ±‚çš„jsonæ•°æ®å¯¹è±¡åœ¨å†…éƒ¨å¯¹åº”ä¸¤ä¸ªç»“æ„ä½“ï¼šå®¢æˆ·ç«¯æ˜¯clientRequestï¼ŒæœåŠ¡ç«¯æ˜¯serverRequestã€‚clientRequestå’ŒserverRequestç»“æ„ä½“çš„å†…å®¹åŸºæœ¬æ˜¯ä¸€è‡´çš„ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>type</span> <span class=nx>clientRequest</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>Method</span> <span class=kt>string</span>         <span class=s>`json:&quot;method&quot;`</span>
    <span class=nx>Params</span> <span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=kd>interface</span><span class=p>{}</span> <span class=s>`json:&quot;params&quot;`</span>
    <span class=nx>Id</span>     <span class=kt>uint64</span>         <span class=s>`json:&quot;id&quot;`</span>
<span class=p>}</span>

<span class=kd>type</span> <span class=nx>serverRequest</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>Method</span> <span class=kt>string</span>           <span class=s>`json:&quot;method&quot;`</span>
    <span class=nx>Params</span> <span class=o>*</span><span class=nx>json</span><span class=p>.</span><span class=nx>RawMessage</span> <span class=s>`json:&quot;params&quot;`</span>
    <span class=nx>Id</span>     <span class=o>*</span><span class=nx>json</span><span class=p>.</span><span class=nx>RawMessage</span> <span class=s>`json:&quot;id&quot;`</span>
<span class=p>}</span>
</code></pre></div> <p>åœ¨è·å–åˆ°RPCè°ƒç”¨å¯¹åº”çš„jsonæ•°æ®åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç›´æ¥å‘æ¶è®¾äº†RPCæœåŠ¡çš„TCPæœåŠ¡å™¨å‘é€jsonæ•°æ®æ¨¡æ‹ŸRPCæ–¹æ³•è°ƒç”¨ï¼š</p> <div class=highlight><pre><span></span><code>$ <span class=nb>echo</span> -e <span class=s1>&#39;{&quot;method&quot;:&quot;HelloService.Hello&quot;,&quot;params&quot;:[&quot;hello&quot;],&quot;id&quot;:1}&#39;</span> <span class=p>|</span> nc localhost <span class=m>1234</span>
</code></pre></div> <p>è¿”å›çš„ç»“æœä¹Ÿæ˜¯ä¸€ä¸ªjsonæ ¼å¼çš„æ•°æ®ï¼š</p> <div class=highlight><pre><span></span><code><span class=p>{</span><span class=nt>&quot;id&quot;</span><span class=p>:</span><span class=mi>1</span><span class=p>,</span><span class=nt>&quot;result&quot;</span><span class=p>:</span><span class=s2>&quot;hello:hello&quot;</span><span class=p>,</span><span class=nt>&quot;error&quot;</span><span class=p>:</span><span class=kc>null</span><span class=p>}</span>
</code></pre></div> <p>å…¶ä¸­idå¯¹åº”è¾“å…¥çš„idå‚æ•°ï¼Œresultä¸ºè¿”å›çš„ç»“æœï¼Œerroréƒ¨åˆ†åœ¨å‡ºé—®é¢˜æ—¶è¡¨ç¤ºé”™è¯¯ä¿¡æ¯ã€‚å¯¹äºé¡ºåºè°ƒç”¨æ¥è¯´ï¼Œidä¸æ˜¯å¿…é¡»çš„ã€‚ä½†æ˜¯Goè¯­è¨€çš„RPCæ¡†æ¶æ”¯æŒå¼‚æ­¥è°ƒç”¨ï¼Œå½“è¿”å›ç»“æœçš„é¡ºåºå’Œè°ƒç”¨çš„é¡ºåºä¸ä¸€è‡´æ—¶ï¼Œå¯ä»¥é€šè¿‡idæ¥è¯†åˆ«å¯¹åº”çš„è°ƒç”¨ã€‚</p> <p>è¿”å›çš„jsonæ•°æ®ä¹Ÿæ˜¯å¯¹åº”å†…éƒ¨çš„ä¸¤ä¸ªç»“æ„ä½“ï¼šå®¢æˆ·ç«¯æ˜¯clientResponseï¼ŒæœåŠ¡ç«¯æ˜¯serverResponseã€‚ä¸¤ä¸ªç»“æ„ä½“çš„å†…å®¹åŒæ ·ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼š</p> <div class=highlight><pre><span></span><code><span class=kd>type</span> <span class=nx>clientResponse</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>Id</span>     <span class=kt>uint64</span>           <span class=s>`json:&quot;id&quot;`</span>
    <span class=nx>Result</span> <span class=o>*</span><span class=nx>json</span><span class=p>.</span><span class=nx>RawMessage</span> <span class=s>`json:&quot;result&quot;`</span>
    <span class=nx>Error</span>  <span class=kd>interface</span><span class=p>{}</span>      <span class=s>`json:&quot;error&quot;`</span>
<span class=p>}</span>

<span class=kd>type</span> <span class=nx>serverResponse</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>Id</span>     <span class=o>*</span><span class=nx>json</span><span class=p>.</span><span class=nx>RawMessage</span> <span class=s>`json:&quot;id&quot;`</span>
    <span class=nx>Result</span> <span class=kd>interface</span><span class=p>{}</span>      <span class=s>`json:&quot;result&quot;`</span>
    <span class=nx>Error</span>  <span class=kd>interface</span><span class=p>{}</span>      <span class=s>`json:&quot;error&quot;`</span>
<span class=p>}</span>
</code></pre></div> <h2 id=httprpc>Httpä¸Šçš„RPC<a class=headerlink href=#httprpc title="Permanent link">&para;</a></h2> <p>Goè¯­è¨€å†…åœ¨çš„ RPC æ¡†æ¶å·²ç»æ”¯æŒåœ¨ Http åè®®ä¸Šæä¾› RPC æœåŠ¡ã€‚ä½†æ˜¯æ¡†æ¶çš„ http æœåŠ¡åŒæ ·é‡‡ç”¨äº†å†…ç½®çš„ gob åè®®ï¼Œå¹¶ä¸”æ²¡æœ‰æä¾›é‡‡ç”¨å…¶å®ƒåè®®çš„æ¥å£ï¼Œå› æ­¤ä»å…¶å®ƒè¯­è¨€ä¾ç„¶æ— æ³•è®¿é—®çš„ã€‚</p> <p>ä¸¾ä¸ªğŸŒ°</p> <div class=highlight><pre><span></span><code><span class=kd>func</span> <span class=nx>main</span><span class=p>()</span> <span class=p>{</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nx>RegisterName</span><span class=p>(</span><span class=s>&quot;HelloService&quot;</span><span class=p>,</span> <span class=nb>new</span><span class=p>(</span><span class=nx>HelloService</span><span class=p>))</span>

    <span class=nx>http</span><span class=p>.</span><span class=nx>HandleFunc</span><span class=p>(</span><span class=s>&quot;/jsonrpc&quot;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
        <span class=kd>var</span> <span class=nx>conn</span> <span class=nx>io</span><span class=p>.</span><span class=nx>ReadWriteCloser</span> <span class=p>=</span> <span class=kd>struct</span> <span class=p>{</span>
            <span class=nx>io</span><span class=p>.</span><span class=nx>Writer</span>
            <span class=nx>io</span><span class=p>.</span><span class=nx>ReadCloser</span>
        <span class=p>}{</span>
            <span class=nx>ReadCloser</span><span class=p>:</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Body</span><span class=p>,</span>
            <span class=nx>Writer</span><span class=p>:</span>     <span class=nx>w</span><span class=p>,</span>
        <span class=p>}</span>

        <span class=nx>rpc</span><span class=p>.</span><span class=nx>ServeRequest</span><span class=p>(</span><span class=nx>jsonrpc</span><span class=p>.</span><span class=nx>NewServerCodec</span><span class=p>(</span><span class=nx>conn</span><span class=p>))</span>
    <span class=p>})</span>

    <span class=nx>http</span><span class=p>.</span><span class=nx>ListenAndServe</span><span class=p>(</span><span class=s>&quot;:1234&quot;</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
<span class=p>}</span>
</code></pre></div> <p>RPC çš„æœåŠ¡æ¶è®¾åœ¨ â€œ/jsonrpcâ€ è·¯å¾„ï¼Œåœ¨å¤„ç†å‡½æ•°ä¸­åŸºäº http.ResponseWriter å’Œ http.Request ç±»å‹çš„å‚æ•°æ„é€ ä¸€ä¸ª io.ReadWriteCloser ç±»å‹çš„ conn é€šé“ã€‚ç„¶ååŸºäº conn æ„å»ºé’ˆå¯¹æœåŠ¡ç«¯çš„ json ç¼–ç è§£ç å™¨ã€‚æœ€åé€šè¿‡ rpc.ServeRequest å‡½æ•°ä¸ºæ¯æ¬¡è¯·æ±‚å¤„ç†ä¸€æ¬¡ RPC æ–¹æ³•è°ƒç”¨ã€‚</p> <p>æ¨¡æ‹Ÿä¸€æ¬¡RPCè°ƒç”¨çš„è¿‡ç¨‹å°±æ˜¯å‘è¯¥é“¾æ¥å‘é€ä¸€ä¸ª json å­—ç¬¦ä¸²ï¼š</p> <div class=highlight><pre><span></span><code>$ curl localhost:1234/jsonrpc -X POST <span class=se>\</span>
    --data <span class=s1>&#39;{&quot;method&quot;:&quot;HelloService.Hello&quot;,&quot;params&quot;:[&quot;hello&quot;],&quot;id&quot;:0}&#39;</span>
</code></pre></div> <p>è¿”å›çš„ç»“æœä¾ç„¶æ˜¯ json å­—ç¬¦ä¸²ï¼š</p> <div class=highlight><pre><span></span><code><span class=p>{</span><span class=nt>&quot;id&quot;</span><span class=p>:</span><span class=mi>0</span><span class=p>,</span><span class=nt>&quot;result&quot;</span><span class=p>:</span><span class=s2>&quot;hello:hello&quot;</span><span class=p>,</span><span class=nt>&quot;error&quot;</span><span class=p>:</span><span class=kc>null</span><span class=p>}</span>
</code></pre></div> <h2 id=rpc>æ›´å¤š RPC ç¤ºä¾‹<a class=headerlink href=#rpc title="Permanent link">&para;</a></h2> <h3 id=http-rpc>HTTP RPC<a class=headerlink href=#http-rpc title="Permanent link">&para;</a></h3> <p>æœåŠ¡ç«¯ï¼š</p> <div class=highlight><pre><span></span><code><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=p>(</span>
    <span class=s>&quot;errors&quot;</span>
    <span class=s>&quot;fmt&quot;</span>
    <span class=s>&quot;net/http&quot;</span>
    <span class=s>&quot;net/rpc&quot;</span>
<span class=p>)</span>

<span class=kd>type</span> <span class=nx>Args</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>A</span><span class=p>,</span> <span class=nx>B</span> <span class=kt>int</span>
<span class=p>}</span>

<span class=kd>type</span> <span class=nx>Quotient</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>Quo</span><span class=p>,</span> <span class=nx>Rem</span> <span class=kt>int</span>
<span class=p>}</span>

<span class=kd>type</span> <span class=nx>Arith</span> <span class=kt>int</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>Arith</span><span class=p>)</span> <span class=nx>Multiply</span><span class=p>(</span><span class=nx>args</span> <span class=o>*</span><span class=nx>Args</span><span class=p>,</span> <span class=nx>reply</span> <span class=o>*</span><span class=kt>int</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=o>*</span><span class=nx>reply</span> <span class=p>=</span> <span class=nx>args</span><span class=p>.</span><span class=nx>A</span> <span class=o>*</span> <span class=nx>args</span><span class=p>.</span><span class=nx>B</span>
    <span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>Arith</span><span class=p>)</span> <span class=nx>Divide</span><span class=p>(</span><span class=nx>args</span> <span class=o>*</span><span class=nx>Args</span><span class=p>,</span> <span class=nx>quo</span> <span class=o>*</span><span class=nx>Quotient</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=k>if</span> <span class=nx>args</span><span class=p>.</span><span class=nx>B</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nx>errors</span><span class=p>.</span><span class=nx>New</span><span class=p>(</span><span class=s>&quot;divide by zero&quot;</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=nx>quo</span><span class=p>.</span><span class=nx>Quo</span> <span class=p>=</span> <span class=nx>args</span><span class=p>.</span><span class=nx>A</span> <span class=o>/</span> <span class=nx>args</span><span class=p>.</span><span class=nx>B</span>
    <span class=nx>quo</span><span class=p>.</span><span class=nx>Rem</span> <span class=p>=</span> <span class=nx>args</span><span class=p>.</span><span class=nx>A</span> <span class=o>%</span> <span class=nx>args</span><span class=p>.</span><span class=nx>B</span>
    <span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nx>main</span><span class=p>()</span> <span class=p>{</span>

    <span class=nx>arith</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>Arith</span><span class=p>)</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nx>Register</span><span class=p>(</span><span class=nx>arith</span><span class=p>)</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nx>HandleHTTP</span><span class=p>()</span>

    <span class=nx>err</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ListenAndServe</span><span class=p>(</span><span class=s>&quot;:1234&quot;</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>fmt</span><span class=p>.</span><span class=nx>Println</span><span class=p>(</span><span class=nx>err</span><span class=p>.</span><span class=nx>Error</span><span class=p>())</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>æˆ‘ä»¬æ³¨å†Œäº†ä¸€ä¸ª Arith çš„ RPC æœåŠ¡ï¼Œç„¶åé€šè¿‡<code>rpc.HandleHTTP</code>å‡½æ•°æŠŠè¯¥æœåŠ¡æ³¨å†Œåˆ°äº† HTTP åè®®ä¸Šï¼Œå°±å¯ä»¥åˆ©ç”¨ http çš„æ–¹å¼æ¥ä¼ é€’æ•°æ®äº†ã€‚</p> <p>å®¢æˆ·ç«¯ï¼š</p> <div class=highlight><pre><span></span><code><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=p>(</span>
    <span class=s>&quot;fmt&quot;</span>
    <span class=s>&quot;log&quot;</span>
    <span class=s>&quot;net/rpc&quot;</span>
    <span class=s>&quot;os&quot;</span>
<span class=p>)</span>

<span class=kd>type</span> <span class=nx>Args</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>A</span><span class=p>,</span> <span class=nx>B</span> <span class=kt>int</span>
<span class=p>}</span>

<span class=kd>type</span> <span class=nx>Quotient</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>Quo</span><span class=p>,</span> <span class=nx>Rem</span> <span class=kt>int</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nx>main</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>2</span> <span class=p>{</span>
        <span class=nx>fmt</span><span class=p>.</span><span class=nx>Println</span><span class=p>(</span><span class=s>&quot;Usage: &quot;</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=s>&quot;server&quot;</span><span class=p>)</span>
        <span class=nx>os</span><span class=p>.</span><span class=nx>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=nx>serverAddress</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>

    <span class=nx>client</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rpc</span><span class=p>.</span><span class=nx>DialHTTP</span><span class=p>(</span><span class=s>&quot;tcp&quot;</span><span class=p>,</span> <span class=nx>serverAddress</span><span class=o>+</span><span class=s>&quot;:1234&quot;</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>log</span><span class=p>.</span><span class=nx>Fatal</span><span class=p>(</span><span class=s>&quot;dialing:&quot;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=c1>// Synchronous call</span>
    <span class=nx>args</span> <span class=o>:=</span> <span class=nx>Args</span><span class=p>{</span><span class=mi>17</span><span class=p>,</span> <span class=mi>8</span><span class=p>}</span>
    <span class=kd>var</span> <span class=nx>reply</span> <span class=kt>int</span>
    <span class=nx>err</span> <span class=p>=</span> <span class=nx>client</span><span class=p>.</span><span class=nx>Call</span><span class=p>(</span><span class=s>&quot;Arith.Multiply&quot;</span><span class=p>,</span> <span class=nx>args</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>reply</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>log</span><span class=p>.</span><span class=nx>Fatal</span><span class=p>(</span><span class=s>&quot;arith error:&quot;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=nx>fmt</span><span class=p>.</span><span class=nx>Printf</span><span class=p>(</span><span class=s>&quot;Arith: %d*%d=%d\n&quot;</span><span class=p>,</span> <span class=nx>args</span><span class=p>.</span><span class=nx>A</span><span class=p>,</span> <span class=nx>args</span><span class=p>.</span><span class=nx>B</span><span class=p>,</span> <span class=nx>reply</span><span class=p>)</span>

    <span class=kd>var</span> <span class=nx>quot</span> <span class=nx>Quotient</span>
    <span class=nx>err</span> <span class=p>=</span> <span class=nx>client</span><span class=p>.</span><span class=nx>Call</span><span class=p>(</span><span class=s>&quot;Arith.Divide&quot;</span><span class=p>,</span> <span class=nx>args</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>quot</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>log</span><span class=p>.</span><span class=nx>Fatal</span><span class=p>(</span><span class=s>&quot;arith error:&quot;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=nx>fmt</span><span class=p>.</span><span class=nx>Printf</span><span class=p>(</span><span class=s>&quot;Arith: %d/%d=%d remainder %d\n&quot;</span><span class=p>,</span> <span class=nx>args</span><span class=p>.</span><span class=nx>A</span><span class=p>,</span> <span class=nx>args</span><span class=p>.</span><span class=nx>B</span><span class=p>,</span> <span class=nx>quot</span><span class=p>.</span><span class=nx>Quo</span><span class=p>,</span> <span class=nx>quot</span><span class=p>.</span><span class=nx>Rem</span><span class=p>)</span>

<span class=p>}</span>
</code></pre></div> <p>æŠŠä¸Šé¢çš„æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„ä»£ç åˆ†åˆ«ç¼–è¯‘ï¼Œç„¶åå…ˆæŠŠæœåŠ¡ç«¯å¼€å¯ï¼Œç„¶åå¼€å¯å®¢æˆ·ç«¯ï¼Œè¾“å…¥ä»£ç ï¼Œå°±ä¼šè¾“å‡ºå¦‚ä¸‹ä¿¡æ¯ï¼š</p> <div class=highlight><pre><span></span><code>$ ./http_c localhost
Arith: <span class=m>17</span>*8<span class=o>=</span><span class=m>136</span>
Arith: <span class=m>17</span>/8<span class=o>=</span><span class=m>2</span> remainder <span class=m>1</span>
</code></pre></div> <p>é€šè¿‡ä¸Šé¢çš„è°ƒç”¨å¯ä»¥çœ‹åˆ°å‚æ•°å’Œè¿”å›å€¼æ˜¯è‡ªå®šä¹‰çš„ struct ç±»å‹ï¼Œåœ¨æœåŠ¡ç«¯æŠŠå®ƒä»¬å½“åšè°ƒç”¨å‡½æ•°çš„å‚æ•°çš„ç±»å‹ï¼Œåœ¨å®¢æˆ·ç«¯ä½œä¸º<code>client.Call</code>çš„ç¬¬2ï¼Œ3ä¸¤ä¸ªå‚æ•°çš„ç±»å‹ã€‚å®¢æˆ·ç«¯çš„ Call å‡½æ•°æœ‰3ä¸ªå‚æ•°ï¼Œç¬¬1ä¸ªè¦è°ƒç”¨çš„å‡½æ•°çš„åå­—ï¼Œç¬¬2ä¸ªæ˜¯è¦ä¼ é€’çš„å‚æ•°ï¼Œç¬¬3ä¸ªè¦è¿”å›çš„å‚æ•°(æ³¨æ„æ˜¯æŒ‡é’ˆç±»å‹)ã€‚</p> <h3 id=tcp-rpc>TCP RPC<a class=headerlink href=#tcp-rpc title="Permanent link">&para;</a></h3> <p>æœåŠ¡ç«¯ï¼š</p> <p>è¿™ä¸ªä»£ç å’Œ http çš„æœåŠ¡å™¨ç›¸æ¯”ï¼Œä¸åŒåœ¨äºé‡‡ç”¨äº† TCP åè®®ï¼Œéœ€è¦è‡ªå·±æ§åˆ¶è¿æ¥ï¼Œå½“æœ‰å®¢æˆ·ç«¯è¿æ¥ä¸Šæ¥åï¼Œæˆ‘ä»¬éœ€è¦æŠŠè¿™ä¸ªè¿æ¥äº¤ç»™ rpc æ¥å¤„ç†ã€‚</p> <div class=highlight><pre><span></span><code><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=p>(</span>
    <span class=s>&quot;errors&quot;</span>
    <span class=s>&quot;fmt&quot;</span>
    <span class=s>&quot;net&quot;</span>
    <span class=s>&quot;net/rpc&quot;</span>
    <span class=s>&quot;os&quot;</span>
<span class=p>)</span>

<span class=kd>type</span> <span class=nx>Args</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>A</span><span class=p>,</span> <span class=nx>B</span> <span class=kt>int</span>
<span class=p>}</span>

<span class=kd>type</span> <span class=nx>Quotient</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>Quo</span><span class=p>,</span> <span class=nx>Rem</span> <span class=kt>int</span>
<span class=p>}</span>

<span class=kd>type</span> <span class=nx>Arith</span> <span class=kt>int</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>Arith</span><span class=p>)</span> <span class=nx>Multiply</span><span class=p>(</span><span class=nx>args</span> <span class=o>*</span><span class=nx>Args</span><span class=p>,</span> <span class=nx>reply</span> <span class=o>*</span><span class=kt>int</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=o>*</span><span class=nx>reply</span> <span class=p>=</span> <span class=nx>args</span><span class=p>.</span><span class=nx>A</span> <span class=o>*</span> <span class=nx>args</span><span class=p>.</span><span class=nx>B</span>
    <span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>Arith</span><span class=p>)</span> <span class=nx>Divide</span><span class=p>(</span><span class=nx>args</span> <span class=o>*</span><span class=nx>Args</span><span class=p>,</span> <span class=nx>quo</span> <span class=o>*</span><span class=nx>Quotient</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=k>if</span> <span class=nx>args</span><span class=p>.</span><span class=nx>B</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nx>errors</span><span class=p>.</span><span class=nx>New</span><span class=p>(</span><span class=s>&quot;divide by zero&quot;</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=nx>quo</span><span class=p>.</span><span class=nx>Quo</span> <span class=p>=</span> <span class=nx>args</span><span class=p>.</span><span class=nx>A</span> <span class=o>/</span> <span class=nx>args</span><span class=p>.</span><span class=nx>B</span>
    <span class=nx>quo</span><span class=p>.</span><span class=nx>Rem</span> <span class=p>=</span> <span class=nx>args</span><span class=p>.</span><span class=nx>A</span> <span class=o>%</span> <span class=nx>args</span><span class=p>.</span><span class=nx>B</span>
    <span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nx>main</span><span class=p>()</span> <span class=p>{</span>

    <span class=nx>arith</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>Arith</span><span class=p>)</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nx>Register</span><span class=p>(</span><span class=nx>arith</span><span class=p>)</span>

    <span class=nx>tcpAddr</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nx>ResolveTCPAddr</span><span class=p>(</span><span class=s>&quot;tcp&quot;</span><span class=p>,</span> <span class=s>&quot;:1234&quot;</span><span class=p>)</span>
    <span class=nx>checkError</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>

    <span class=nx>listener</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nx>ListenTCP</span><span class=p>(</span><span class=s>&quot;tcp&quot;</span><span class=p>,</span> <span class=nx>tcpAddr</span><span class=p>)</span>
    <span class=nx>checkError</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>

    <span class=k>for</span> <span class=p>{</span>
        <span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>listener</span><span class=p>.</span><span class=nx>Accept</span><span class=p>()</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=k>continue</span>
        <span class=p>}</span>
        <span class=nx>rpc</span><span class=p>.</span><span class=nx>ServeConn</span><span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
    <span class=p>}</span>

<span class=p>}</span>

<span class=kd>func</span> <span class=nx>checkError</span><span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>fmt</span><span class=p>.</span><span class=nx>Println</span><span class=p>(</span><span class=s>&quot;Fatal error &quot;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nx>Error</span><span class=p>())</span>
        <span class=nx>os</span><span class=p>.</span><span class=nx>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>å®¢æˆ·ç«¯ï¼š</p> <p>å’Œ http çš„å®¢æˆ·ç«¯ä»£ç å¯¹æ¯”ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯ç”¨ rpc.Dial å–ä»£äº† rpc.DialHTTPï¼Œå…¶ä»–å¤„ç†ä¸€æ¨¡ä¸€æ ·ã€‚</p> <div class=highlight><pre><span></span><code><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=p>(</span>
    <span class=s>&quot;fmt&quot;</span>
    <span class=s>&quot;log&quot;</span>
    <span class=s>&quot;net/rpc&quot;</span>
    <span class=s>&quot;os&quot;</span>
<span class=p>)</span>

<span class=kd>type</span> <span class=nx>Args</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>A</span><span class=p>,</span> <span class=nx>B</span> <span class=kt>int</span>
<span class=p>}</span>

<span class=kd>type</span> <span class=nx>Quotient</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>Quo</span><span class=p>,</span> <span class=nx>Rem</span> <span class=kt>int</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nx>main</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>2</span> <span class=p>{</span>
        <span class=nx>fmt</span><span class=p>.</span><span class=nx>Println</span><span class=p>(</span><span class=s>&quot;Usage: &quot;</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=s>&quot;server:port&quot;</span><span class=p>)</span>
        <span class=nx>os</span><span class=p>.</span><span class=nx>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=nx>service</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>

    <span class=nx>client</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rpc</span><span class=p>.</span><span class=nx>Dial</span><span class=p>(</span><span class=s>&quot;tcp&quot;</span><span class=p>,</span> <span class=nx>service</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>log</span><span class=p>.</span><span class=nx>Fatal</span><span class=p>(</span><span class=s>&quot;dialing:&quot;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=c1>// Synchronous call</span>
    <span class=nx>args</span> <span class=o>:=</span> <span class=nx>Args</span><span class=p>{</span><span class=mi>17</span><span class=p>,</span> <span class=mi>8</span><span class=p>}</span>
    <span class=kd>var</span> <span class=nx>reply</span> <span class=kt>int</span>
    <span class=nx>err</span> <span class=p>=</span> <span class=nx>client</span><span class=p>.</span><span class=nx>Call</span><span class=p>(</span><span class=s>&quot;Arith.Multiply&quot;</span><span class=p>,</span> <span class=nx>args</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>reply</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>log</span><span class=p>.</span><span class=nx>Fatal</span><span class=p>(</span><span class=s>&quot;arith error:&quot;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=nx>fmt</span><span class=p>.</span><span class=nx>Printf</span><span class=p>(</span><span class=s>&quot;Arith: %d*%d=%d\n&quot;</span><span class=p>,</span> <span class=nx>args</span><span class=p>.</span><span class=nx>A</span><span class=p>,</span> <span class=nx>args</span><span class=p>.</span><span class=nx>B</span><span class=p>,</span> <span class=nx>reply</span><span class=p>)</span>

    <span class=kd>var</span> <span class=nx>quot</span> <span class=nx>Quotient</span>
    <span class=nx>err</span> <span class=p>=</span> <span class=nx>client</span><span class=p>.</span><span class=nx>Call</span><span class=p>(</span><span class=s>&quot;Arith.Divide&quot;</span><span class=p>,</span> <span class=nx>args</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>quot</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>log</span><span class=p>.</span><span class=nx>Fatal</span><span class=p>(</span><span class=s>&quot;arith error:&quot;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=nx>fmt</span><span class=p>.</span><span class=nx>Printf</span><span class=p>(</span><span class=s>&quot;Arith: %d/%d=%d remainder %d\n&quot;</span><span class=p>,</span> <span class=nx>args</span><span class=p>.</span><span class=nx>A</span><span class=p>,</span> <span class=nx>args</span><span class=p>.</span><span class=nx>B</span><span class=p>,</span> <span class=nx>quot</span><span class=p>.</span><span class=nx>Quo</span><span class=p>,</span> <span class=nx>quot</span><span class=p>.</span><span class=nx>Rem</span><span class=p>)</span>

<span class=p>}</span>
</code></pre></div> <h3 id=json-rpc>JSON RPC<a class=headerlink href=#json-rpc title="Permanent link">&para;</a></h3> <p>JSON RPCæ˜¯æ•°æ®ç¼–ç é‡‡ç”¨äº†JSONï¼Œè€Œä¸æ˜¯gobç¼–ç ï¼Œå…¶ä»–å’Œä¸Šé¢ä»‹ç»çš„RPCæ¦‚å¿µä¸€æ¨¡ä¸€æ ·ã€‚è¯¦è§ <a href=https://golang.org/pkg/net/rpc/jsonrpc/ >jsonrpcåŒ…</a></p> <p>json-rpcæ˜¯åŸºäºTCPåè®®å®ç°çš„ï¼Œç›®å‰å®ƒè¿˜ä¸æ”¯æŒHTTPæ–¹å¼ã€‚</p> <p>æœåŠ¡ç«¯ï¼š</p> <div class=highlight><pre><span></span><code><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=p>(</span>
    <span class=s>&quot;errors&quot;</span>
    <span class=s>&quot;fmt&quot;</span>
    <span class=s>&quot;net&quot;</span>
    <span class=s>&quot;net/rpc&quot;</span>
    <span class=s>&quot;net/rpc/jsonrpc&quot;</span>
    <span class=s>&quot;os&quot;</span>
<span class=p>)</span>

<span class=kd>type</span> <span class=nx>Args</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>A</span><span class=p>,</span> <span class=nx>B</span> <span class=kt>int</span>
<span class=p>}</span>

<span class=kd>type</span> <span class=nx>Quotient</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>Quo</span><span class=p>,</span> <span class=nx>Rem</span> <span class=kt>int</span>
<span class=p>}</span>

<span class=kd>type</span> <span class=nx>Arith</span> <span class=kt>int</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>Arith</span><span class=p>)</span> <span class=nx>Multiply</span><span class=p>(</span><span class=nx>args</span> <span class=o>*</span><span class=nx>Args</span><span class=p>,</span> <span class=nx>reply</span> <span class=o>*</span><span class=kt>int</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=o>*</span><span class=nx>reply</span> <span class=p>=</span> <span class=nx>args</span><span class=p>.</span><span class=nx>A</span> <span class=o>*</span> <span class=nx>args</span><span class=p>.</span><span class=nx>B</span>
    <span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=p>(</span><span class=nx>t</span> <span class=o>*</span><span class=nx>Arith</span><span class=p>)</span> <span class=nx>Divide</span><span class=p>(</span><span class=nx>args</span> <span class=o>*</span><span class=nx>Args</span><span class=p>,</span> <span class=nx>quo</span> <span class=o>*</span><span class=nx>Quotient</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
    <span class=k>if</span> <span class=nx>args</span><span class=p>.</span><span class=nx>B</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nx>errors</span><span class=p>.</span><span class=nx>New</span><span class=p>(</span><span class=s>&quot;divide by zero&quot;</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=nx>quo</span><span class=p>.</span><span class=nx>Quo</span> <span class=p>=</span> <span class=nx>args</span><span class=p>.</span><span class=nx>A</span> <span class=o>/</span> <span class=nx>args</span><span class=p>.</span><span class=nx>B</span>
    <span class=nx>quo</span><span class=p>.</span><span class=nx>Rem</span> <span class=p>=</span> <span class=nx>args</span><span class=p>.</span><span class=nx>A</span> <span class=o>%</span> <span class=nx>args</span><span class=p>.</span><span class=nx>B</span>
    <span class=k>return</span> <span class=kc>nil</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nx>main</span><span class=p>()</span> <span class=p>{</span>

    <span class=nx>arith</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>Arith</span><span class=p>)</span>
    <span class=nx>rpc</span><span class=p>.</span><span class=nx>Register</span><span class=p>(</span><span class=nx>arith</span><span class=p>)</span>

    <span class=nx>tcpAddr</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nx>ResolveTCPAddr</span><span class=p>(</span><span class=s>&quot;tcp&quot;</span><span class=p>,</span> <span class=s>&quot;:1234&quot;</span><span class=p>)</span>
    <span class=nx>checkError</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>

    <span class=nx>listener</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nx>ListenTCP</span><span class=p>(</span><span class=s>&quot;tcp&quot;</span><span class=p>,</span> <span class=nx>tcpAddr</span><span class=p>)</span>
    <span class=nx>checkError</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>

    <span class=k>for</span> <span class=p>{</span>
        <span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>listener</span><span class=p>.</span><span class=nx>Accept</span><span class=p>()</span>
        <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
            <span class=k>continue</span>
        <span class=p>}</span>
        <span class=nx>jsonrpc</span><span class=p>.</span><span class=nx>ServeConn</span><span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
    <span class=p>}</span>

<span class=p>}</span>

<span class=kd>func</span> <span class=nx>checkError</span><span class=p>(</span><span class=nx>err</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>fmt</span><span class=p>.</span><span class=nx>Println</span><span class=p>(</span><span class=s>&quot;Fatal error &quot;</span><span class=p>,</span> <span class=nx>err</span><span class=p>.</span><span class=nx>Error</span><span class=p>())</span>
        <span class=nx>os</span><span class=p>.</span><span class=nx>Exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>å®¢æˆ·ç«¯ï¼š</p> <div class=highlight><pre><span></span><code><span class=kn>package</span> <span class=nx>main</span>

<span class=kn>import</span> <span class=p>(</span>
    <span class=s>&quot;fmt&quot;</span>
    <span class=s>&quot;log&quot;</span>
    <span class=s>&quot;net/rpc/jsonrpc&quot;</span>
    <span class=s>&quot;os&quot;</span>
<span class=p>)</span>

<span class=kd>type</span> <span class=nx>Args</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>A</span><span class=p>,</span> <span class=nx>B</span> <span class=kt>int</span>
<span class=p>}</span>

<span class=kd>type</span> <span class=nx>Quotient</span> <span class=kd>struct</span> <span class=p>{</span>
    <span class=nx>Quo</span><span class=p>,</span> <span class=nx>Rem</span> <span class=kt>int</span>
<span class=p>}</span>

<span class=kd>func</span> <span class=nx>main</span><span class=p>()</span> <span class=p>{</span>
    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>2</span> <span class=p>{</span>
        <span class=nx>fmt</span><span class=p>.</span><span class=nx>Println</span><span class=p>(</span><span class=s>&quot;Usage: &quot;</span><span class=p>,</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=s>&quot;server:port&quot;</span><span class=p>)</span>
        <span class=nx>log</span><span class=p>.</span><span class=nx>Fatal</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=nx>service</span> <span class=o>:=</span> <span class=nx>os</span><span class=p>.</span><span class=nx>Args</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>

    <span class=nx>client</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>jsonrpc</span><span class=p>.</span><span class=nx>Dial</span><span class=p>(</span><span class=s>&quot;tcp&quot;</span><span class=p>,</span> <span class=nx>service</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>log</span><span class=p>.</span><span class=nx>Fatal</span><span class=p>(</span><span class=s>&quot;dialing:&quot;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=c1>// Synchronous call</span>
    <span class=nx>args</span> <span class=o>:=</span> <span class=nx>Args</span><span class=p>{</span><span class=mi>17</span><span class=p>,</span> <span class=mi>8</span><span class=p>}</span>
    <span class=kd>var</span> <span class=nx>reply</span> <span class=kt>int</span>
    <span class=nx>err</span> <span class=p>=</span> <span class=nx>client</span><span class=p>.</span><span class=nx>Call</span><span class=p>(</span><span class=s>&quot;Arith.Multiply&quot;</span><span class=p>,</span> <span class=nx>args</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>reply</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>log</span><span class=p>.</span><span class=nx>Fatal</span><span class=p>(</span><span class=s>&quot;arith error:&quot;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=nx>fmt</span><span class=p>.</span><span class=nx>Printf</span><span class=p>(</span><span class=s>&quot;Arith: %d*%d=%d\n&quot;</span><span class=p>,</span> <span class=nx>args</span><span class=p>.</span><span class=nx>A</span><span class=p>,</span> <span class=nx>args</span><span class=p>.</span><span class=nx>B</span><span class=p>,</span> <span class=nx>reply</span><span class=p>)</span>

    <span class=kd>var</span> <span class=nx>quot</span> <span class=nx>Quotient</span>
    <span class=nx>err</span> <span class=p>=</span> <span class=nx>client</span><span class=p>.</span><span class=nx>Call</span><span class=p>(</span><span class=s>&quot;Arith.Divide&quot;</span><span class=p>,</span> <span class=nx>args</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>quot</span><span class=p>)</span>
    <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
        <span class=nx>log</span><span class=p>.</span><span class=nx>Fatal</span><span class=p>(</span><span class=s>&quot;arith error:&quot;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
    <span class=p>}</span>
    <span class=nx>fmt</span><span class=p>.</span><span class=nx>Printf</span><span class=p>(</span><span class=s>&quot;Arith: %d/%d=%d remainder %d\n&quot;</span><span class=p>,</span> <span class=nx>args</span><span class=p>.</span><span class=nx>A</span><span class=p>,</span> <span class=nx>args</span><span class=p>.</span><span class=nx>B</span><span class=p>,</span> <span class=nx>quot</span><span class=p>.</span><span class=nx>Quo</span><span class=p>,</span> <span class=nx>quot</span><span class=p>.</span><span class=nx>Rem</span><span class=p>)</span>

<span class=p>}</span>
</code></pre></div> <hr> <div class=md-source-date> <small> Last update: May 16, 2020 </small> </div> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <script src=../../assets/javascripts/vendor.22b62ea4.min.js></script> <script src=../../assets/javascripts/bundle.5f27aba8.min.js></script><script id=__lang type=application/json>{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script> <script>
        app = initialize({
          base: "../..",
          features: ["instant", "tabs"],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.f6ebf1dc.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script> </body> </html>